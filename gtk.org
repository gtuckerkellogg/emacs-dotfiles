
#+TITLE:     Greg Tucker-Kellogg's Emacs configuration
#+AUTHOR:    Greg Tucker-Kellogg


* Front matter :ignore:
#+DESCRIPTION:
#+PROPERTY: header-args :tangle no :results silent
#+KEYWORDS:
#+STARTUP: noindent
#+LANGUAGE:  en
#+OPTIONS:   H:3 num:t toc:t \n:nil @:t ::t |:t ^:t -:t f:t *:t <:t
#+OPTIONS:   TeX:t LaTeX:t skip:nil d:nil todo:t pri:nil tags:not-in-toc
#+INFOJS_OPT: view:nil toc:t ltoc:t mouse:underline buttons:0 path:http://orgmode.org/org-info.js
#+EXPORT_SELECT_TAGS: export
#+EXPORT_EXCLUDE_TAGS: noexport
#+LINK_UP:   
#+LINK_HOME: 
#+XSLT:
#+LATEX_HEADER: \usepackage{gtuckerkellogg}


#+BEGIN_SRC emacs-lisp :results silent :exports none :tangle yes
  ;; these languages that don't need confirmation
  (defun my-org-confirm-babel-evaluate (lang body)
    (cond
     ((string= lang "latex") nil)
     ((string= lang "emacs-lisp") nil)
     (t "default")))

  (setq org-confirm-babel-evaluate 'my-org-confirm-babel-evaluate)
#+END_SRC


* General Emacs behaviour

** Information only

#+name: me
#+BEGIN_SRC emacs-lisp :tangle yes
  (setq user-full-name "Greg Tucker-Kellogg" 
        user-mail-address "dbsgtk@gmail.com")
  (require 'cl-lib)
#+END_SRC


** Some functions

These are almost trivial functions, but I find them useful What is going on here and why is everything double-spaced. Oh maybe this is an interaction between visual line mode and visual-fill-column-mode.

#+BEGIN_SRC emacs-lisp :tangle yes

  (defun  gtk/emacs-path (path)
    (expand-file-name path user-emacs-directory))

  (add-to-list 'load-path (gtk/emacs-path "lisp/"))

  (defalias 'gtk/emacs-subdir 'gtk/emacs-path)

  (defun turn-off-cua-mode ()
    (cua-mode -1))

  (defun turn-on-visual-line-mode ()
    (interactive)
    (visual-line-mode 1))

  (defun turn-off-visual-line-mode ()
    (interactive)
    (visual-line-mode -1))

  (defun switch-to-minibuffer-window ()
    "switch to minibuffer window (if active)"
    (interactive)
    (when (active-minibuffer-window)
      (select-window (active-minibuffer-window))))
  (global-set-key (kbd "<f7>") 'switch-to-minibuffer-window)
  (global-set-key (kbd "C-z") 'undo)

#+END_SRC

** Key bindings

I have some keys that I'd like to be always bound

#+name: gtk-keys

#+BEGIN_SRC emacs-lisp :tangle yes


  (global-set-key (kbd "C-c C-w") 'copy-region-as-kill)

  (global-set-key (kbd "C-c q") 'auto-fill-mode)

  (global-set-key (kbd "M-+") 'count-words)


#+END_SRC




** Emacs client and window behaviour



#+BEGIN_SRC emacs-lisp :tangle yes
  (server-start)
  (setq inhibit-startup-message t)
  (tool-bar-mode -1)
  (tooltip-mode -1)
  (menu-bar-mode +1)
  (scroll-bar-mode -1)
  (setq visible-bell t)
  (setq-default fill-column 110)
  (setq custom-file (gtk/emacs-path "custom.el"))
  (load custom-file)
  (global-auto-revert-mode)
#+END_SRC

** vc-use package


** Visual fill column


#+begin_src emacs-lisp :tangle yes
  (use-package visual-fill-column
  :init
  (setq visual-fill-column-width 110
	visual-fill-column-center-text t)
  :config
  (defun turn-on-visual-fill-column ()
    (interactive)
    ;; Center the presentation and wrap lines
    (visual-fill-column-mode 1)
    (visual-line-mode 1))
  (defun turn-off-visual-fill-column ()
    ;; Center the presentation and wrap lines
    (visual-fill-column-mode 0)
    (visual-line-mode 0))
  )
#+end_src

** Enable minibuffer completion

#+begin_src emacs-lisp :tangle yes
  (icomplete-mode 1)
  (setq scroll-step 0)
  (setq scroll-conservatively 10000)
  (setq auto-window-vscroll nil)
#+end_src

** Text behaviour
I'm trying to wean myself off the old school double spacing for
sentence ending.  Also in LaTeX.

#+begin_src emacs-lisp :tangle yes
  (define-key global-map (kbd "C-+") 'text-scale-increase)
  (define-key global-map (kbd "C--") 'text-scale-decrease)
  (setq sentence-end-double-space nil)
  (global-set-key (kbd "M-/") 'hippie-expand) ;; may ways of finding things
  (global-set-key (kbd "C-x ^") 'join-line)
  (global-set-key (kbd "C-x C-m") 'execute-extended-command) ;; M-x without meta
#+end_src

** backups and ignored extensions

#+BEGIN_SRC emacs-lisp :tangle yes

  (add-to-list 'completion-ignored-extensions ".los")
  (setq backup-directory-alist `(("." . ,(expand-file-name
                                        (concat user-emacs-directory "backups")))))

#+END_SRC

** Miscellany

This is mostly from starter-kit-misc.

#+begin_src emacs-lisp :eval yes
  (auto-compression-mode t) ;; open compressed files without an issue
  (recentf-mode 1) ;; keep a list of recent files
  (show-paren-mode 1)
  (setq diff-switches "-u")
#+end_src

** System specific settings

#+begin_src emacs-lisp :tangle yes
  (org-babel-load-file (expand-file-name "system-settings.org" user-emacs-directory))
#+end_src

* File configuration

** First we have some of my file organization

#+begin_src emacs-lisp :tangle yes
  (set-default 'tramp-default-proxies-alist (quote ((".*" "\\`root\\'" "/ssh:%h:"))))

  (defvar dropbox-root  
    (convert-standard-filename "~/Dropbox/")
      "This is where Dropbox should be mounted on all of my systems")

    (defvar gtk/personal-elisp-dir (convert-standard-filename  
                                    (concat dropbox-root "emacs/lisp/"))
      "Where I will keep some extra personal elisp stuff")
#+end_src

** Check Dependencies

#+begin_src emacs-lisp :eval yes :tangle yes
  (dolist (package '(autoinsert visual-regexp 
                              js2-mode typo flycheck-popup-tip
                              gist 
                              ))
       (straight-use-package package))

#+end_src

* Themes

This is my modus stuff

#+begin_src emacs-lisp :tangle yes
  (use-package zenburn-theme)
    
    (use-package modus-themes
      :config
      (setq modus-themes-mode-line '(accented borderless padded)
    	  modus-themes-paren-match '(bold rainbow)
    	  modus-themes-deuteranopia t
    	  modus-themes-slanted-constructs t
    	  modus-themes-scale-headings nil
    	  modus-themes-intense-mouseovers t
    	  modus-themes-bold-constructs t
    	  modus-themes-org-blocks 'grayscale-background
    	  modus-themes-headings '((1 . (rainbow background overline bold 1.3))
    				  (2 . (rainbow background 1.2))
    				  (3 . (rainbow bold 1.1))
    				  (t . (semilight 1.0)))
    	  )
      )


#+end_src


* Mode line behaviour


#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package diminish)

  (use-package smart-mode-line
    :config
    (setq sml/no-confirm-load-theme t)
    (sml/setup)
    (sml/apply-theme 'respectful)  ; Respect the theme colors
    (setq sml/mode-width 'right
          sml/name-width 60)

    (setq-default mode-line-format

                  `("%e"
                    mode-line-front-space
                    mode-line-mule-info
                    mode-line-client
                    mode-line-modified
                    mode-line-remote
                    mode-line-frame-identification
                    mode-line-buffer-identification
                    sml/pos-id-separator
                    (vc-mode vc-mode)
                    " "
                    mode-line-position
                    sml/pre-modes-separator
                    mode-line-modes
                    " "
                    mode-line-misc-info))

    (setq rm-excluded-modes
          (mapconcat
           'identity
                                          ; These names must start with a space!
           '(" GitGutter" " MRev" " company"
             " Helm" " Undo-Tree" " Projectile.*" " Z" " Ind"
             " Org-Agenda.*" " ElDoc" " SP/s" " cider.*")
           "\\|")))

#+end_src


#+begin_src emacs-lisp :tangle yes
  (use-package doom-themes :defer t)

  (defun disable-all-themes ()
    "disable all active themes."
    (dolist (i custom-enabled-themes)
      (disable-theme i)))


  (defun fresh-load-theme (theme &optional no-confirm)
    (interactive
     (list
      (intern (completing-read "Load custom theme: "
			       (mapcar #'symbol-name
				       (custom-available-themes))))
      nil
      ))
    (unless (custom-theme-name-valid-p theme)
      (error "Invalid theme name `%s'" theme))
    (message (concat "Theme is: " (symbol-name theme)))
    (when (custom-theme-p theme)
      (put theme 'theme-settings nil)
      (put theme 'theme-feature nil)
      (put theme 'theme-documentation nil))
    (let ((file (locate-file (concat (symbol-name theme) "-theme.el")
			     (custom-theme--load-path)
			     '("" "c")))
	  (custom--inhibit-theme-enable t))
      ;; Check file safety with `custom-safe-themes', prompting the
      ;; user if necessary.
      (cond ((not file)
	     (error "Unable to find theme file for `%s'" theme))
	    ((or no-confirm
		 (eq custom-safe-themes t)
		 (and (memq 'default custom-safe-themes)
		      (equal (file-name-directory file)
			     (expand-file-name "themes/" data-directory))))
	     ;; Theme is safe; load byte-compiled version if available.
	     (load (file-name-sans-extension file) nil t nil t))
	    ((with-temp-buffer
	       (insert-file-contents file)
	       (let ((hash (secure-hash 'sha256 (current-buffer))))
		 (when (or (member hash custom-safe-themes)
			   (custom-theme-load-confirm hash))
		   (eval-buffer nil nil file)
		   t))))
	    (t
	     (error "Unable to load theme `%s'" theme))))
    ;; Optimization: if the theme changes the `default' face, put that
    ;; entry first.  This avoids some `frame-set-background-mode' rigmarole
    ;; by assigning the new background immediately.
    (let* ((settings (get theme 'theme-settings))
	   (tail settings)
	   found)
      (while (and tail (not found))
	(and (eq (nth 0 (car tail)) 'theme-face)
	     (eq (nth 1 (car tail)) 'default)
	     (setq found (car tail)))
	(setq tail (cdr tail)))
      (when found
	(put theme 'theme-settings (cons found (delq found settings)))))
    ;; Finally, enable the theme.
    (disable-all-themes)
    (enable-theme theme)
    t)



  ;;(fresh-load-theme 'doom-moonlight)
  ;;(fresh-load-theme 'doom-tomorrow-night t)
  ;;(fresh-load-theme 'doom-wilmersdorf t)
  ;;(fresh-load-theme 'modus-operandi t)
  ;;(fresh-load-theme 'modus-vivendi t)
					  ;(fresh-load-theme 'doom-flatwhite)
  ;;(fresh-load-theme 'doom-plain t)
#+end_src



*** Getting icons.

In order to use this, you must run ~(all-the-icons-install-fonts)~ after installing the package ~all-the-icons~. 

#+begin_src emacs-lisp :tangle yes

  (use-package all-the-icons)

  (use-package minions
    :config (minions-mode 1))


  (use-package doom-modeline
    :ensure t
    :init (doom-modeline-mode 1)
    :hook (after-init . doom-modeline-mode)
    :custom-face
    (mode-line ((t (:height 1.0))))
    (mode-line-inactive ((t (:height 0.85))))
    :custom
    (doom-modeline-height 15)
    (doom-modeline-bar-width 6)
    (doom-modeline-lsp t)
    (doom-modeline-github nil)
    (doom-modeline-mu4e nil)
    (doom-modeline-irc nil)
    (doom-modeline-minor-modes t)
    (doom-modeline-persp-name nil)
    (doom-modeline-buffer-file-name-style 'truncate-except-project)
    (doom-modeline-major-mode-icon t))
#+end_src



#+begin_src emacs-lisp :eval no :tangle no
  (org-babel-load-file (gtk/emacs-path "exwm.org"))
#+end_src



* Org mode

** Org modules and backends

#+begin_src emacs-lisp :tangle yes
        (mapcar
         (lambda (x) (add-to-list 'org-modules x))
         '(;org-sticky-header
           ox-latex
           ox-odt
    ;;       ox-extra
           org-tempo
           org-agenda
           org-habit
           org-habit
    ;;       org-ref
           ol
           ox
           org-indent
           ))
  (require 'ox)

      (org-export-define-derived-backend 'beamer 'latex
      :menu-entry
      '(?l 1
           ((?B "As LaTeX buffer (Beamer)" org-beamer-export-as-latex)
      	(?b "As LaTeX file (Beamer)" org-beamer-export-to-latex)
      	(?P "As PDF file (Beamer)" org-beamer-export-to-pdf)
      	(?O "As PDF file and open (Beamer)"
      	    (lambda (a s v b)
      	      (if a (org-beamer-export-to-pdf t s v b)
      		(org-open-file (org-beamer-export-to-pdf nil s v b)))))))
      :options-alist
      '((:headline-levels nil "H" org-beamer-frame-level)
        (:latex-class "LATEX_CLASS" nil "beamer" t)
        (:beamer-subtitle-format nil nil org-beamer-subtitle-format)
        (:beamer-column-view-format "COLUMNS" nil org-beamer-column-view-format)
        (:beamer-theme "BEAMER_THEME" nil org-beamer-theme)
        (:beamer-color-theme "BEAMER_COLOR_THEME" nil nil t)
        (:beamer-font-theme "BEAMER_FONT_THEME" nil nil t)
        (:beamer-inner-theme "BEAMER_INNER_THEME" nil nil t)
        (:beamer-outer-theme "BEAMER_OUTER_THEME" nil nil t)
        (:beamer-header "BEAMER_HEADER" nil nil newline)
        (:beamer-environments-extra nil nil org-beamer-environments-extra)
        (:beamer-frame-default-options nil nil org-beamer-frame-default-options)
        (:beamer-outline-frame-options nil nil org-beamer-outline-frame-options)
        (:beamer-outline-frame-title nil nil org-beamer-outline-frame-title))
      :translate-alist '((strike-through . org-beamer-bold)
      		     (export-block . org-beamer-export-block)
      		     (export-snippet . org-beamer-export-snippet)
      		     (headline . org-beamer-headline)
      		     (item . org-beamer-item)
      		     (keyword . org-beamer-keyword)
      		     (link . org-beamer-link)
      		     (plain-list . org-beamer-plain-list)
      		     (radio-target . org-beamer-radio-target)
      		     (template . org-beamer-template)))

      (use-package org-contrib)
      (use-package ox-extra)
      (use-package org-sticky-header)
      (use-package org-ref)

    (use-package org
      :custom
      (org-latex-image-default-option "keepaspectratio,height=0.8\\textheight")
      (org-latex-image-default-width "0.8\\linewidth")
      (org-latex-image-default-height "0.75\\textheight")
      )

        (mapcar
         (lambda (x) (add-to-list 'org-export-backends x :append))
         '(beamer
           odt))

        (defun org-beamer-bold (bold contents _info)
        "Transcode BLOCK object into Beamer code.
      CONTENTS is the text being bold.  INFO is a plist used as
      a communication channel."
        (format "\\textbf%s{%s}"
      	  (or (org-beamer--element-has-overlay-p bold) "")
      	  contents))


        ;; (use-package org-sticky-header
        ;;   :ensure t
        ;;   :hook
        ;;   (org-mode . org-sticky-header-mode))

        (use-package org-auto-tangle
          :defer t
          :hook (org-mode . org-auto-tangle-mode)
          :config
          (setq org-auto-tangle-default t))

#+end_src

** General Org options

*** File organisation 

#+begin_src emacs-lisp :tangle yes :eval yes
  (setq org-directory
        (expand-file-name "_support/org" dropbox-root))

  (defun  gtk/org-path (path)
    (expand-file-name path org-directory))

  (setq org-clock-sound (concat dropbox-root "share/sounds/good-idea-shiny-ding-3-SBA-300457978.wav"))

  (setq org-use-speed-commands
        (lambda () (and (looking-at org-outline-regexp) (looking-back "^\**"))))

  (defvar my/inbox
    (expand-file-name (concat dropbox-root "/_inbox/inbox.org"))
    "My inbox")

  (setq org-default-notes-file my/inbox)

  (defvar my/organizer (gtk/org-path  "organizer.org") 
    "My main tasks list")

  (defvar my/journal
    (expand-file-name (concat dropbox-root "/_inbox/journal.org"))
    "My journal")
#+end_src

*** Loading up 

#+begin_src emacs-lisp :tangle yes

  (use-package org
    :ensure t
    :hook
    (org-mode . turn-off-auto-fill)
    (org-mode . turn-on-visual-line-mode)
    (org.mode . turn-off-cua-mode)  
    :custom
    (org-insert-mode-line-in-empty-file t)
    (org-startup-indented nil)
    (org-startup-folded 'nofold)
    (org-completion-use-ido nil)
    (org-outline-path-complete-in-steps nil)
    (org-latex-prefer-user-labels t)
    :config
    (with-eval-after-load 'ox-extra
      (ox-extras-activate '(latex-header-blocks ignore-headlines)))
    :bind
    (("C-c C-x C-2" . org-cite-insert)
     ("C-c C-x C-3" . ivy-immediate-done)))



 #+end_src

*** Getting smart quotes

#+begin_src emacs-lisp :tangle yes
  (use-package typo
    :ensure t
    :init
    (setq-default typo-language "English")
    (defun typo-off () (interactive) (typo-mode -1))
    (defun typo-on ()  (interactive) (typo-mode 1))
    (defun local-org-typo-hook ()
      (typo-mode 1)
      (add-hook 'typo-disable-electricity-functions 'org-in-src-block-p nil :local))
    (add-hook 'org-mode-hook 'local-org-typo-hook))
#+end_src



** The agenda

#+begin_src emacs-lisp :tangle yes
  (setq org-agenda-files (expand-file-name "agenda-files" org-directory ))
  (setq org-agenda-window-setup 'current-window)
  (setq org-agenda-start-with-log-mode t)  
#+end_src

#+BEGIN_SRC emacs-lisp :tangle yes
  (setq diary-file (expand-file-name (concat dropbox-root "/diary"))) 
#+end_src 


#+name agenda-commands
#+begin_src emacs-lisp :tangle yes

  (setq org-agenda-custom-commands
        '(("n" "Agenda and all TODOs"
           ((agenda "")
            (alltodo "")))
          ("P" todo "PROJECT")
          ))
#+end_src

#+BEGIN_SRC emacs-lisp :tangle yes

        (use-package org-super-agenda
         :init
         (org-super-agenda-mode))

        ;; (setq org-super-agenda-groups
        ;;       '((:auto-category t)))

        (setq org-super-agenda-groups
              '(
                (:name "Overdue items"
                       :order 1
                       :deadline past)
                (:name "Lagging items"
                       :order 2
                       :scheduled past)
                (:name "Today's items"
                       :scheduled today
                       :deadline today
                       :order 3)
                (:name "High priority"
                       :priority "A"
                       :order 4)
                (:name "Easy wins"
                       :effort< "0:30"
                       :order 5)
                (:name "Medium priority or coming up"
                       :priority<= "B"
                       :scheduled future
                       :deadline future
                       :order 5)

                (:name "Other next actions"
                       :todo ("NEXT")
                       :order 10
                       )
                (:name "Unscheduled Projects"
                       :todo ("PROJECT")
                       :order 99)
                (:name "Waiting for"
                       :todo ("WAITING")
                       :order 100)
        ))

        (setq  org-agenda-skip-scheduled-if-deadline-is-shown t)
        (setq  org-agenda-skip-deadline-prewarning-if-scheduled t)
#+END_SRC


** My GTD setup

*** My Next Action list setup
#+name: next-actions
#+begin_src emacs-lisp :tangle yes

  (setq org-todo-keywords
             '((type "NEXT(n)" "TODO(t)" "PROJECT(p)" "|" "DONE(d@/!)")
               (type "WAITING(w@/!)" "HOLD(h@/!)" "|" "CANCELLED(c@/!)")))

  (setq org-todo-state-tags-triggers
        '(("CANCELLED" ("CANCELLED" . t))
          ("WAITING" ("WAITING" . t))
          ("HOLD" ("WAITING" . t) ("HOLD" . t))
          (done ("WAITING") ("HOLD"))
          ("TODO" ("WAITING") ("CANCELLED") ("HOLD"))
          ("NEXT" ("WAITING") ("CANCELLED") ("HOLD"))
          ("DONE" ("WAITING") ("CANCELLED") ("HOLD"))))

  (setq org-log-into-drawer "LOGBOOK")
#+end_src

*** Categories as Areas of focus

I use David Allen's "Areas of Focus" for general categories across org stuff

#+begin_src emacs-lisp :tangle yes
  (setq org-global-properties
        '(("CATEGORY_ALL" 
           . "Family Finance Work Health Relationships Self Explore Other")))
  (setq org-columns-default-format "%35ITEM %TODO %3PRIORITY %20CATEGORY %TAGS") 
#+end_src 


*** Context in tags

My default tags should be context

#+BEGIN_SRC emacs-lisp :tangle yes
  (setq org-tag-persistent-alist
        '((:startgroup . nil)
          ("@Office" . ?o)
          ("@Computer" . ?c)
          ("@Internet" . ?i)
          ("@Home" . ?h)
          ("@Errands" . ?e)
          (:endgroup . nil)
          (:startgroup . nil)
          ("Project" . ?p)
          ("Agenda" . ?a)
          (:endgroup . nil)
          ("FLAGGED" . ?f)
          ("noexport" . ?n)
          ("ignore" . ?I)
          ))
#+END_SRC

But project tags should never be inherited

#+BEGIN_SRC emacs-lisp :tangle yes
  (setq org-tags-exclude-from-inheritance '("Project"))
#+END_SRC
** Key bindings in Org

#+begin_src emacs-lisp :tangle yes
  (global-set-key (kbd "C-'") 'org-cycle-agenda-files)
;  (define-key org-mode-map (kbd "C-c )") 'reftex-citation)
  (global-set-key "\C-cl" 'org-store-link)
  (define-key org-mode-map "\C-ci" 'org-insert-link)
  (global-set-key (kbd  "C-c a") 'org-agenda)
  (global-set-key "\C-cj" 'org-clock-goto)
  (global-set-key "\C-cc" 'org-capture)
  (setq org-clock-into-drawer "CLOCKING")
  (global-set-key "\C-c'" 'org-cycle-agenda-files)
  (define-key global-map "\C-cx"
    (lambda () (interactive) (org-capture nil "i")))
#+end_src

** Org capture behavior

#+begin_src emacs-lisp  :tangle yes

  (use-package org-journal
    :ensure t
    :defer nil
    :custom
    (org-journal-dir (gtk/org-path "journal/"))
    (org-journal-date-format "%A, %d %B %Y")
    (org-journal-file-type 'monthly)
    :bind (("C-c M-j" . org-journal-new-entry)))


  (defun org-journal-find-location ()
    ;; Open today's journal, but specify a non-nil prefix argument in order to
    ;; inhibit inserting the heading; org-capture will insert the heading.
    (org-journal-new-entry t)
    ;; Position point on the journal's top-level heading so that org-capture
    ;; will add the new entry as a child entry.
    (goto-char (point-min)))

  (setq org-capture-templates
        `(
          ("w" "Todo items (work)" entry (file+olp my/organizer "Work" "Actions")
           "* TODO %?\n  %i")

          ("t" "Todo items" entry (file+headline my/organizer "Tasks")
           "* TODO %?\n  %i")
          ("T" "Todo items (with link)" entry (file+headline my/organizer "Tasks")
           "* TODO %?\n  %i\n  %a")
          ("i" "Into the inbox" entry (file+datetree my/inbox)
           "* %?\n\nEntered on %U\n  %i" )
          ("j" "Journal entry" entry (function org-journal-find-location)
           "* %(format-time-string org-journal-time-format)%^{Title}\n%i%?")
          ("R" "Weekly review"  entry (file+headline my/organizer  "Weekly Review")
           (file ,(expand-file-name (concat org-directory "templates/weekly-review.org")))
           )
          ;; ("j" "Journal entries" entry (file+datetree my/journal)
          ;;  "* %?\n\nEntered on %U\n  %i\n  %a" )
          ;; ("J" "Journal entries from nowhere" entry (file+datetree my/journal)
          ;;  "* %?\n\nEntered on %U\n  %i\n" )
          ))
#+end_src 

 
** Archiving and refiling

#+begin_src emacs-lisp :eval tangle yes
  (setq org-refile-use-outline-path 'file
        org-refile-use-cache nil)

  (setq org-refile-targets '((my/organizer :maxlevel . 1 )
                             (my/organizer :tag . "TAG" )
                             ))
#+end_src
  


** Bullets

#+begin_src emacs-lisp :tangle yes
  ;; (use-package org-bullets
  ;;   :after org
  ;;   :hook (org-mode . org-bullets-mode))

  (use-package org-superstar
    :after org
    :hook (org-mode . org-superstar-mode))
#+end_src



** Org Babel


#+begin_src emacs-lisp :tangle yes
  (org-babel-do-load-languages
   'org-babel-load-languages
   '((emacs-lisp . t)
     (R . t)
     (shell . t)    
     (dot . t)
     (ruby . t)
     (python . t)  ;; requires return statement
     (perl . t)
     (latex . t)
     (clojure . t)  ;; oh, why doesn't this work?
     )
   )
#+end_src



** Org agenda cleanup

This (including the comment below) is from
http://orgmode.org/worg/org-contrib/org-mac-iCal.html

#+begin_quote
A common problem with all-day and multi-day events in org agenda view
is that they become separated from timed events and are placed below
all TODO items.  Likewise, additional fields such as Location: are
orphaned from their parent events. The following hook will ensure that
all events are correctly placed in the agenda.
#+end_quote

#+begin_src emacs-lisp
  (defun org-agenda-cleanup-diary-long-events ()
    (goto-char (point-min))
    (save-excursion
      (while (re-search-forward "^[a-z]" nil t)
        (goto-char (match-beginning 0))
        (insert "0:00-24:00 ")))
    (while (re-search-forward "^ [a-z]" nil t)
      (goto-char (match-beginning 0))
      (save-excursion
        (re-search-backward "^[0-9]+:[0-9]+-[0-9]+:[0-9]+ " nil t))
      (insert (match-string 0))))
  (add-hook 'org-agenda-cleanup-fancy-diary-hook 'org-agenda-cleanup-diary-long-events)
#+end_src       


This is some stuff

** Org visuals
:PROPERTIES:
:test:     some drawer value
:END:

#+begin_src emacs-lisp :tangle yes

              (set-face-attribute 'default nil :font "Open Sans" :weight 'medium) 

          (set-face-attribute 'fixed-pitch nil
  			    :font "Input Mono Narrow"
  			    :weight 'light
  			    :height 1.0
            		    )

          (set-face-attribute 'variable-pitch nil
            			    :font "Open Sans")


              (set-face-attribute 'org-default nil :inherit 'variable-pitch)

  (face-all-attributes 'fixed-pitch)

              (dolist (face '((org-level-1 . 1.3)
            		  (org-level-2 . 1.2)
            		  (org-level-3 . 1.1)
            		  (org-level-4 . 1.1)
            		  (org-level-5 . 1.1)
            		  (org-level-6 . 1.1)
            		  (org-level-7 . 1.1)))
                (set-face-attribute (car face) nil :inherit 'variable-pitch :weight 'regular :height (cdr face)))
              (set-face-attribute 'org-level-1 nil :weight 'normal)
              (set-face-attribute 'org-level-2 nil :weight 'bold)
            (set-face-attribute 'org-block-begin-line nil :inherit '(shadow fixed-pitch) :height 0.8 :weight 'bold)  
            (set-face-attribute 'modus-themes-fixed-pitch nil :inherit 'fixed-pitch :height 0.9)

              

              (set-face-attribute 'org-block nil :foreground nil :inherit 'fixed-pitch)
              (set-face-attribute 'org-table nil  :inherit 'fixed-pitch)
              (set-face-attribute 'org-drawer nil  :inherit '(font-lock-comment-face fixed-pitch) :height 0.8)
              (set-face-attribute 'org-formula nil  :inherit 'fixed-pitch)
              (set-face-attribute 'org-code nil   :inherit '(shadow fixed-pitch))
              (set-face-attribute 'org-verbatim nil :inherit '(shadow fixed-pitch))
              (set-face-attribute 'org-special-keyword nil :inherit '(font-lock-comment-face fixed-pitch))
              (set-face-attribute 'org-meta-line nil :inherit '(font-lock-comment-face fixed-pitch))
              (set-face-attribute 'org-checkbox nil :inherit 'fixed-pitch)

#+end_src


I want the habits display to be a little to the right. I'll use the
Chinese character 今 for today, and a ☺ for completed habits

#+begin_src emacs-lisp :tangle yes
  (setq  org-habit-completed-glyph 9786 
         org-habit-graph-column 80
         org-habit-show-habits-only-for-today t
         org-habit-today-glyph 20170  
         org-hide-leading-stars t
         org-pretty-entities nil)
#+end_src

#+begin_src emacs-lisp :tangle yes
    (setq org-attach-method 'ln)
  (require 'org-faces)
  (setq org-use-property-inheritance '("PRIORITY" "STYLE" "CATEGORY"))
    (setq org-agenda-start-day "0d")
    (setq org-agenda-span 'week)
    (setq org-agenda-start-on-weekday nil)
    (setq org-agenda-skip-scheduled-if-done t)
    (setq org-agenda-skip-deadline-if-done t)

    (setq org-fontify-done-headline t)
    (defun org-column-view-uses-fixed-width-face ()
      ;; copy from org-faces.el
      (when (fboundp 'set-face-attribute)
	;; Make sure that a fixed-width face is used when we have a column
	;; table.
	(set-face-attribute 'org-column nil
			    :height (face-attribute 'default :height)
			    :family (face-attribute 'default :family))
	(set-face-attribute 'org-column-title nil
			    :height (face-attribute 'default :height)
			    :family (face-attribute 'default :family)
			    )))


  (when (and (fboundp 'daemonp) (daemonp))
      (add-hook 'org-mode-hook 'org-column-view-uses-fixed-width-face))
      ;; (add-hook 'org-mode-hook 'org-column-view-uses-fixed-width-face)

#+end_src



** General export

*** Latex

#+begin_src emacs-lisp :tangle yes
  (setq org-latex-pdf-process
	'("latexmk -f -pdf -%latex -interaction=nonstopmode -shell-escape -output-directory=%o %f"))

 	
#+end_src

*** org-memoir

#+begin_src emacs-lisp :tangle yes
  (add-to-list 'org-latex-classes  `("memoir-article"
         (,@ (concat  "\\documentclass[11pt,article,oneside,a4paper,x11names]{memoir}\n"
                      "% -- DEFAULT PACKAGES \n[DEFAULT-PACKAGES]\n"
                      "% -- PACKAGES \n[PACKAGES]\n"
                      "% -- EXTRA \n[EXTRA]\n"
                      "\\counterwithout{section}{chapter}\n"
                      ))
         ("\\section{%s}" . "\\section{%s}")
         ("\\subsection{%s}" . "\\subsection{%s}")
         ("\\subsubsection{%s}" . "\\subsubsection{%s}")
         ("\\paragraph{%s}" . "\\paragraph{%s}")
         ("\\subparagraph{%s}" . "\\subparagraph{%s}")))

#+end_src


*** Minted for code

#+begin_src emacs-lisp :tangle yes

    (setq org-latex-src-block-backend 'minted)
;
    (setq org-latex-packages-alist '())
    ;(add-to-list 'org-latex-packages-alist '("cache=false" "minted"))
    (add-to-list 'org-latex-packages-alist '("" "color"))
  ;  (add-to-list 'org-latex-packages-alist '("" "gtkminted") 'append)
    (add-to-list 'org-latex-packages-alist '("" "csquotes"))
    (add-to-list 'org-latex-minted-langs '(groovy "groovy"))
    (add-to-list 'org-latex-minted-langs '(R "r"))
    (add-to-list 'org-latex-minted-langs '(clojure "clojure"))


      (setq org-latex-minted-options
  	    '(("linenos" "true")
  	      ("fontsize" "\\scriptsize")
  	      ("stepnumber" "1")))

    (setq my-org-minted-config (concat "%% minted package configuration settings\n"
  				       "\\definecolor{bg}{HTML}{E5E5E5}\n" 
  				       "\\usemintedstyle{trac}\n"
  				       "\\usepackage{upquote}\n"
  				       "\\renewcommand{\\theFancyVerbLine}{\\sffamily\\tiny \\textcolor[rgb]{1.0,0,0}{\\arabic{FancyVerbLine}}}\n"
  				       "\\AtBeginDocument{%\n"
  				       "%\\def\\PYZsq{\\textquotesingle}%\n"
  				       "}\n"
  				       "%% end minted package configuration"
  					))


#+end_src


*** Removing captions in Beamer

#+BEGIN_SRC emacs-lisp :tangle yes
      (defun gtk/unnumbered-beamer-caption (contents backend info)
        (when (eq backend 'beamer)
          (replace-regexp-in-string "\\\\caption\{" "\\\\caption*{" contents)))

#+end_SRC


#+BEGIN_SRC emacs-lisp :tangle yes

  (defun my/unnumbered-captions-p ()
  (let* ((props (org-collect-keywords '("PROPERTY")))
         (entries (cdr (assoc "PROPERTY" props)))
         val)
    (dolist (entry entries)
      (when (string-match "\\`unnumbered-captions\\s-+\\([^ \t\r\n]+\\)" entry)
        (setq val (match-string 1 entry))))
    (and val (not (member (downcase val) '("nil" "no" "false" "0"))))))

  (defun gtk/unnumbered-latex-captions (contents backend info)
    (when (and (my/unnumbered-captions-p) (eq backend 'latex))
          (replace-regexp-in-string "\\\\caption\{" "\\\\caption*{" contents)))

#+END_SRC






** Other exporters

#+BEGIN_SRC emacs-lisp :tangle yes
(require 'ox-md)
#+END_SRC



** Org-ref

#+begin_src emacs-lisp :tangle yes

  (require 'oc-biblatex)

  (use-package org-ref)

  (setq org-ref-insert-cite-function
      (lambda ()
	(org-cite-insert nil)))

  (define-key org-mode-map (kbd "C-c ]") 'org-ref-insert-link)

  ;  (use-package ivy-bibtex
  ;    :init
  ;    (Setq bibtex-completion-bibliography '((concat (getenv "BIBINPUTS") "/library.bib"))
  ;          bibtex-completion-library-path '((getenv "BIBINPUTS"))))

   ;; (define-key org-mode-map (kbd "C-c ]") 'org-ref-insert-link)

#+end_src


* Some other modes

** Yasnippet


This is yasnippet behavior, cribbed from emacswiki.  


#+begin_src emacs-lisp 

  (use-package yasnippet
    :config
    (add-hook 'prog-mode-hook #'yas-minor-mode))
  (use-package yasnippet-snippets)



  ;;   (yas-global-mode 1)

  ;;   (defun yas/minor-mode-off ()
  ;;     (interactive)
  ;;     (yas/minor-mode -1))

  ;;   (defun yas/minor-mode-on ()
  ;;     (interactive)
  ;;     (yas/minor-mode 1))


  ;;   ;; (add-hook 'org-mode-hook
  ;;   ;;           (lambda ()
  ;;   ;;             (setq-local yas/trigger-key [tab])
  ;;   ;;             (define-key yas/keymap [tab] 'yas/next-field-or-maybe-expand)))

  ;;   (defun yas/org-very-safe-expand ()
  ;;      (let ((yas/fallback-behavior 'return-nil)) (yas/expand)))

  ;; (add-hook 'org-mode-hook
  ;;             (lambda ()
  ;;               (make-variable-buffer-local 'yas/trigger-key)
  ;;               (setq yas/trigger-key [tab])
  ;;               (add-to-list 'org-tab-first-hook 'yas/org-very-safe-expand)
  ;;               (define-key yas/keymap [tab] 'yas/next-field)))

  ;;   (setq help-mode-hook nil)

  ;;   (use-package rainbow-delimiters
  ;;     :config
  ;;     (add-hook 'cider-repl-mode-hook #'rainbow-delimiters-mode)
  ;;     (add-hook 'prog-mode-hook 'rainbow-delimiters-mode))


  ;;         ;;  (add-hook 'help-mode-hook 'yas/minor-mode-off)

  ;;   (add-to-list 'yas-snippet-dirs "~/.emacs.d/snippets/gits")
  ;;   (add-to-list 'yas-snippet-dirs "~/.emacs.d/snippets/mine")





#+end_src



** Popwin and bookmarks

#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package popwin
    :ensure t
    :config (progn
            (popwin-mode 1)))
  (use-package bm
    :ensure t
    :bind* (("C-c b" . bm-toggle)
            ("S-<f3>" . bm-previous)
            ("<f3>" . bm-next)))
#+end_src


** Make dired remove some junk in default view with dired-x

#+begin_src emacs-lisp :tangle yes
    (use-package dired+
      :config
      ;(setq dired-omit-files "^\\.?#\\|^\\.$\\|^\\.\\.$")
      (setq dired-omit-files (concat dired-omit-files "\\|^\\..+$"))
      (add-to-list 'dired-omit-extensions ".pyg") 
      (add-to-list 'dired-omit-extensions ".fls") 
      (add-to-list 'dired-omit-extensions ".fdb_latexmk") 
      (add-to-list 'dired-omit-extensions ".run.xml") 
      (add-hook 'dired-mode-hook 'dired-omit-mode))


#+end_src

** Discoverability 

#+begin_src emacs-lisp :tangle yes
  
(use-package which-key
  :init (which-key-mode)
  :diminish which-key-mode
  :config
  (setq which-key-idle-delay 0.3))

#+end_src


** Command log

#+begin_src emacs-lisp :tangle yes
  (use-package command-log-mode)
  (use-package posframe)

  (setq gtk/command-window-frame nil)
  (defun gtk/toggle-command-window ()
    (interactive)
    (if gtk/command-window-frame
        (progn
          (posframe-delete-frame clm/command-log-buffer)
          (setq gtk/command-window-frame nil))
      (progn
        (global-command-log-mode t)
        (with-current-buffer
            (setq clm/command-log-buffer
                  (get-buffer-create " *command-log*"))
          (text-scale-set -1))
        (setq gtk/command-window-frame
              (posframe-show
               clm/command-log-buffer
               :position `(,(- (frame-width) 200) . 15)
               :width 38
               :height 5
               :min-width 38
               :min-height 5
               :internal-border-width 2
               :internal-border-color "#c792ea"
               :override-parameters '((parent-frame . nil)))))))
#+end_src


* Writing
** Spelling


#+begin_src emacs-lisp :tangle yes
    (use-package flyspell
      :init
      (bind-key "S-<f8>" 'flyspell-mode)
      :config
      (defun gtk/flyspell-check-next-error ()
	(interactive)
	(flyspell-goto-next-error)
	(ispell-word))
      (bind-keys :map flyspell-mode-map
		 ("<f8>" . gtk/flyspell-check-next-error)
		 ("M-S-<f8>" . flyspell-prog-mode))
      (setq ispell-extra-args nil)
      (setq ispell-program-name "hunspell")
      (ispell-set-spellchecker-params)
  ;    (ispell-hunspell-add-multi-dic "en_GB,en_med_glut")
  ;    (ispell-hunspell-add-multi-dic "en_US,en_med_glut")
      (setq ispell-dictionary "en_GB")
      )

    (setq ispell-personal-dictionary "~/.hunspell_personal")



#+end_src

** LaTeX


#+begin_src emacs-lisp :tangle yes
  (setq-default TeX-master t)
  (setq TeX-PDF-mode t)

  (add-hook 'LaTeX-mode-hook 'LaTeX-math-mode)

  (defun getpackage ()
    (interactive)
    (search-backward "\\")
    (re-search-forward "usepackage[^{}]*{" nil t)
    (while (looking-at "\\s-*,*\\([a-zA-Z0-9]+\\)")
      (re-search-forward "\\s-*,*\\([a-zA-Z0-9]+\\)" nil 1)
      (save-excursion
        (find-file-other-window (replace-regexp-in-string "[\n\r ]*" "" (shell-command-to-string (concat "kpsewhich " (match-string 1) ".sty")))))))
  #+end_src




** RefTeX

#+begin_src emacs-lisp :tangle yes
(add-hook 'LaTeX-mode-hook 'turn-on-reftex)

(setq TeX-view-program-selection
      '((output-dvi "DVI Viewer")
        (output-pdf "PDF Viewer")
        (output-html "Google Chrome")))
(setq TeX-view-program-list
      '(("DVI Viewer" "evince %o")
        ("PDF Viewer" "open %o")
        ("Google Chrome" "google-chrome %o")))

(setq reftex-plug-into-AUCTeX t)
(defun org-mode-reftex-setup ()
  (load-library "reftex")
  (and (buffer-file-name)
       (file-exists-p (buffer-file-name))
       (reftex-parse-all))
  (define-key org-mode-map (kbd "C-c )") 'reftex-citation))
(add-hook 'org-mode-hook 'org-mode-reftex-setup)
#+end_src


** handle text mode and markdown 

#+BEGIN_SRC emacs-lisp :tangle yes

    (defvar markdown-cite-format)
    (setq markdown-cite-format
  	  '(
  	    (?\C-m . "[@%l]")
  	    (?p . "[@%l]")
  	    (?t . "@%l")
  	    ))

    ;; (defun markdown-reftex-citation ()
    ;;   (interactive)
    ;;   (let ((reftex-cite-format markdown-cite-format)
    ;; 	  (reftex-cite-key-separator "; @"))
    ;;     (reftex-citation)))


    (use-package markdown-mode
      :ensure t
      :commands (markdown-mode gfm-mode)
      :mode (("README\\.md\\'" . gfm-mode)
  	     ("\\.md\\'" . markdown-mode)
  	     ("\\.markdown\\'" . markdown-mode))
      :init
      (setq markdown-command "pandoc"))

  (setq fill-column 90)
  (add-hook 'markdown-mode-hook 'flyspell-mode)
  (add-hook 'markdown-mode-hook 'turn-on-visual-line-mode)
  (add-hook 'markdown-mode-hook 'turn-off-auto-fill)

  (add-hook 'markdown-mode-hook 'orgtbl-mode)
    (defun my-buffer-face-mode-variable ()
      "Set font to a variable width (proportional) fonts in current buffer"
      (interactive)
      ;;      (setq buffer-face-mode-face '(:family "Bitstream Charter"))
      (setq buffer-face-mode-face '(:family "Open Sans"))
      (buffer-face-mode))

    (defun my-buffer-face-mode-fixed ()
      "Sets a fixed width (monospace) font in current buffer"
      (interactive)
      (setq buffer-face-mode-face '(:family "Fira Code Retina"))
      (buffer-face-mode))

    ;; use a variable font for markdown mode

    (add-hook 'markdown-mode-hook 'my-buffer-face-mode-variable)

    ;; Control + scroll to change font type
    (global-set-key [s-mouse-4] 'my-buffer-face-mode-fixed)
    (global-set-key [s-mouse-5] 'my-buffer-face-mode-variable)


    ;; Shift + scroll to change font size
    (global-set-key [C-mouse-4] 'text-scale-increase)
  (global-set-key [C-mouse-5] 'text-scale-decrease)

  (defun markdown-citation-at-point-p ()
    "Return non-nill if in a citation at point."
    (save-excursion
      (thing-at-point-looking-at "@[-A-Za-z0-9]+")))

  (defun markdown-flyspell-check-word-p ()
    "Return t if `flyspell' should check word just before point.
      Used for `flyspell-generic-check-word-predicate'."
    (save-excursion
      (goto-char (1- (point)))
      (not (or (markdown-code-block-at-point-p)
	       (markdown-inline-code-at-point-p)
	       (markdown-citation-at-point-p)
	       (markdown-in-comment-p)
	       (let ((faces (get-text-property (point) 'face)))
		 (if (listp faces)
		     (or (memq 'markdown-reference-face faces)
			 (memq 'markdown-markup-face faces)
			 (memq 'markdown-url-face faces))
		   (memq faces '(markdown-reference-face
				 markdown-markup-face
				 markdown-url-face))))))))

  (add-hook 'markdown-mode-hook (lambda () (setq flyspell-generic-check-word-predicate 'markdown-flyspell-check-word-p)))
  (put 'markdown-mode-hook 'flyspell-generic-check-word-predicate 'markdown-flyspell-check-word-p)


  (use-package pandoc-mode
    :mode (("\\.md" . markdown-mode)
  	 ("\\.latex" . latex-mode))
    :hook (latex-mode  . pandoc-mode))
;;  :config 'pandoc-load-default-settings)


    (add-hook 'text-mode-hook 'turn-on-auto-fill)

    (use-package autoinsert
      :config
      (setq auto-insert-directory (gtk/emacs-path "insert"))
      (add-to-list 'auto-insert-alist '(("letter\\.tex" . "a letter") .
					"letter-template.tex"
					))

      )

					    ;(add-hook 'markdown-mode-hook 'pandoc-mode)



#+END_SRC




** Link types

I add a few link types to make things look more readable when doing
editing of documents.

A citation link

#+begin_src emacs-lisp 
    (org-add-link-type 
     "cite" nil
     (lambda (path desc format)
       (cond
        ((eq format 'html)
         (if (string-match "\(\\(.*\\)\)" desc)
             (format "(<cite>%s</cite>)" (match-string 1 desc))      
           (format "<cite>%s</cite>" desc)
           )
         )
        ((eq format 'latex)
         (format "\\cite{%s}" path)))))

    (org-add-link-type 
     "TERM" nil
     (lambda (path desc format)
       (cond
        ((eq format 'html)
         path
         )
        ((eq format 'latex)
         (format "%s\\nomenclature{%s}{%s}" desc path desc)))))
    
    (org-add-link-type 
     "Figure" nil
     (lambda (path desc format)
       (cond
        ((eq format 'html)
         path
         )
        ((eq format 'latex)
         (format "Figure~\\ref{fig:%s}" path)))))
    
    (org-add-link-type 
     "Table" nil
     (lambda (path desc format)
       (cond
        ((eq format 'html)
         path
         )
        ((eq format 'latex)
         (format "Table~\\ref{tbl:%s}" path)))))
    
#+end_src       


** Pre-processing hooks for export



** Publishing

#+begin_src emacs-lisp :tangle yes
  (let ((publishing-dir (expand-file-name "Public" dropbox-root)))
    (setq org-publish-project-alist
	  `(("public"
	     :base-directory ,user-emacs-directory
	     :base-extension "org"
	     :publishing-directory ,publishing-dir
	     :publishing-function org-publish-org-to-html
	     )
	    ("Grift"
	       :base-directory ,(expand-file-name "_support/GreatestGrift" dropbox-root)
	       :base-extension "org"	       
	       :publishing-directory ,(expand-file-name "_support/GreatestGrift/Publish" dropbox-root)
	       :publishing-function org-publish-org-to-latex
	       :body-only t
	       :make-index t
	     )
	    ("FOS"
	     :base-directory ,(expand-file-name "_support/DBS/FOS-web" dropbox-root)
	     :base-extension "org\\|css"
	     :publishing-directory "/ftp:dbsgtk@staff.science.nus.edu.sg:/home/"
	     :publishing-function org-publish-org-to-html
	     ))))

#+end_src





** Let's use Sacha Chua's css for HTML export, since it looks purty

#+begin_src emacs-lisp 

(setq org-export-html-style "<link rel=\"stylesheet\" type=\"text/css\" href=\"http://sachachua.com/blog/wp-content/themes/sacha-v3/style.css\" />
<link rel=\"stylesheet\" type=\"text/css\" href=\"http://sachachua.com/org-export.css\" />")
(setq org-export-html-preamble "<div class=\"org-export\">")
(setq org-export-html-postamble "</div>")
(setq org-src-fontify-natively t)
(setq org-export-html-style nil)
#+end_src




* Projectile

#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package projectile
    :ensure    projectile
    :bind-keymap ("C-c p ". projectile-command-map)
    :diminish   projectile-mode
    :custom
    (projectile-completion-system 'ivy)
    (projectile-create-missing-test-files 't)
    :config
    (projectile-global-mode t)
    (projectile-register-project-type 'r
  					'("DESCRIPTION")
  					:project-file "DESCRIPTION"
  					:compile "R CMD build"
  					:src-dir "R/"
  					:test-dir "tests/"
  					:test-prefix "test-")
    )
#+END_SRC

* Ivy, not ido or helm

#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package counsel
    :after ivy
    :config (counsel-mode 1))


  (use-package ivy
    :defer 0.1
    :diminish
    :bind (("C-c C-r" . ivy-resume)
	   ("C-x B" . ivy-switch-buffer-other-window))
    :custom
    (ivy-count-format "(%d/%d) ")
    (ivy-use-virtual-buffers t)
    :config (ivy-mode))


  (use-package ivy-rich
    :after ivy
    :custom
    (ivy-rich-path-style 'abbrev)
    :config
    (ivy-rich-mode 1)
    (setcdr (assq t ivy-format-functions-alist) #'ivy-format-function-line))

  (use-package swiper
    :after ivy
    :bind (("C-s" . swiper)
	   ("C-r" . swiper)))
#+END_SRC


* Programming languages 

** Common

use paredit for lispy languages 

#+begin_src emacs-lisp :tangle yes
   (use-package paredit 
       :ensure t
       :config
       (show-paren-mode t)
       :bind (("M-[" . paredit-wrap-square)
              ("M-{" . paredit-wrap-curly))
       :diminish nil)

  (define-key lisp-mode-shared-map (kbd "C-c l") "lambda") 
  (define-key lisp-mode-shared-map (kbd "RET") 'reindent-then-newline-and-indent)
  (define-key lisp-mode-shared-map (kbd "C-c v") 'eval-buffer)
  (global-set-key (kbd "C-x \\") 'align-regexp)

#+end_src


#+begin_src emacs-lisp :tangle yes
  (use-package smartparens
    :init
    (require 'smartparens-config)
    (add-hook 'org-mode-hook 'smartparens-mode)
    (add-hook 'text-mode-hook 'smartparens-mode)
    (add-hook 'markdown-mode-hook 'smartparens-mode))
#+end_src

#+begin_src emacs-lisp :tangle yes
  (use-package rainbow-delimiters
    :config
    (add-hook 'cider-repl-mode-hook #'rainbow-delimiters-mode)
    (add-hook 'prog-mode-hook 'rainbow-delimiters-mode)) 
#+end_src




#+begin_src emacs-lisp :tangle yes
  (org-babel-load-file (gtk/emacs-path "code-functions.org"))  
  (org-babel-load-file (gtk/emacs-path "shells-and-terminals.org"))
#+end_src

** Emacs lisp


#+begin_src emacs-lisp :tangle yes

  (use-package elisp-slime-nav)

  (use-package elisp-mode :straight (:type built-in)
    :init
    (add-hook  'emacs-lisp-mode-hook #'turn-on-eldoc-mode)
    (add-hook  'emacs-lisp-mode-hook #'gtk/run-prog-hook)
    (add-hook  'emacs-lisp-mode-hook #'enable-paredit-mode)

'gtk/run-prog-hook
    
    (add-hook  'emacs-lisp-mode-hook #'turn-on-elisp-slime-nav-mode)
    :bind (:map emacs-lisp-mode-map
                ("C-c v" . eval-buffer)
                ("C-c C-c" . eval-defun)))

#+end_src

** R

#+name: R and ess
#+begin_src emacs-lisp :tangle yes

       (use-package ess 
   	:mode ("\\.R\\'" . R-mode)
  	:custom
  	(ess-use-flymake nil)
   	:config
   	(add-hook 'ess-r-mode-hook 'smartparens-mode)
   	(setq-default ess-language "R")
   	(setq ess-default-style 'RRR))


  ;; from https://github.com/ess-intro/presentation-ess-customization/blob/main/tutorial/ess-init.el
  (setq ess-R-font-lock-keywords
        '((ess-R-fl-keyword:keywords . t)
  	(ess-R-fl-keyword:constants . t)
  	(ess-R-fl-keyword:modifiers . t)
  	(ess-R-fl-keyword:fun-defs . t)
  	(ess-R-fl-keyword:assign-ops . t)
  	(ess-R-fl-keyword:%op% . t)
  	(ess-fl-keyword:fun-calls . t)
  	(ess-fl-keyword:numbers . t)
  	(ess-fl-keyword:operators)
  	(ess-fl-keyword:delimiters)
  	(ess-fl-keyword:=)
  	(ess-R-fl-keyword:F&T . t)))

  (add-hook 'ess-r-mode-hook
  	  '(lambda ()
  	     (local-set-key (kbd "<f9>") #'ess-rdired)))
  (add-hook 'ess-rdired-mode-hook
  	  '(lambda ()
  	     (local-set-key (kbd "<f9>") #'kill-buffer-and-window)))

  (setq display-buffer-alist
        '(("*R Dired"
  	 (display-buffer-reuse-window display-buffer-at-bottom)
  	 (window-width . 0.5)
  	 (window-height . 0.25)
  	 (reusable-frames . nil))
  	("*R"
  	 (display-buffer-reuse-window display-buffer-in-side-window)
  	 (side . right)
  	 (slot . -1)
  	 (window-width . 0.5)
  	 (reusable-frames . nil))
  	("*Help"
  	 (display-buffer-reuse-window display-buffer-in-side-window)
  	 (side . right)
  	 (slot . 1)
  	 (window-width . 0.5)
  	 (reusable-frames . nil))))

   (with-eval-after-load 'projectile
     (projectile-register-project-type
      'r '("DESCRIPTION")
      :project-file "DESCRIPTION"
      :compile "R CMD INSTALL --with-keep.source ."
      :test "R CMD check -o /tmp/ ."
      :src-dir '("R/" "src/")
      :test-dir "test/" 
      :test-prefix "test-"))





  (use-package poly-R
      :ensure t)

   (use-package quarto-mode
   :mode (("\\.Rmd" . poly-quarto-mode)
   	 ("\\.qmd" . poly-quarto-mode)))
   

#+end_src

** Lua

#+BEGIN_SRC emacs-lisp :eval yes :tangle yes
      (use-package lua-mode
        :ensure t
        :mode (("\\.lua\\'" . lua-mode))
        :bind (:map lua-mode-map
                    ("C-c C-n" . (lambda ()
                                   (interactive)
                                   (lua-send-current-line)
                                   (forward-line)))
                    ("C-c C-r" . lua-send-region)

  ))
#+END_SRC




** Clojure

#+begin_src emacs-lisp :tangle yes

  (use-package cider
    :init
    (add-hook 'clojure-mode-hook #'cider-mode)
    (autoload 'cider--make-result-overlay "cider-overlays")
    (defun endless/eval-overlay (value point)
      (cider--make-result-overlay (format "%S" value)
        :where point
        :duration 'command)
      value)
    (advice-add 'eval-region :around
                (lambda (f beg end &rest r)
                  (endless/eval-overlay
                   (apply f beg end r)
                   end)))
    (advice-add 'eval-last-sexp :filter-return
                (lambda (r)
                  (endless/eval-overlay r (point))))
    (advice-add 'eval-defun :filter-return
                (lambda (r)
                  (endless/eval-overlay
                   r
                   (save-excursion
                     (end-of-defun)
                     (point)))))
    :config
    (add-hook 'cider-mode-hook #'eldoc-mode)
    (add-hook 'cider-mode-hook #'enable-paredit-mode)
    (add-hook 'cider-repl-mode-hook #'enable-paredit-mode)
    (add-hook 'cider-mode-hook 'projectile-mode)
    (setq cider-repl-print-length 100
          nrepl-hide-special-buffers t
          cider-prompt-save-file-on-load nil
          cider-repl-result-prefix ";; => "
          cider-repl-popup-stacktraces t
          cider-auto-select-error-buffer t)

    :bind (:map cider-mode-map ("C-c i" . cider-inspect-last-result)))

  (use-package flycheck
    :ensure t
    :init
    (defun disable-flycheck-in-org-src-block ()
      (setq-local flycheck-disabled-checkers '(emacs-lisp-checkdoc)))
    (add-hook  'org-src-mode-hook 'disable-flycheck-in-org-src-block)
    :config
    (add-hook 'flycheck-mode-hook 'flycheck-popup-tip-mode)
    (define-key flycheck-mode-map flycheck-keymap-prefix nil)
    (setq flycheck-keymap-prefix (kbd "C-c f"))
    (define-key flycheck-mode-map flycheck-keymap-prefix
      flycheck-command-map)
    (global-flycheck-mode))

#+end_src


** Python

I had to remove cython and yasnippet extensions to not screw up
org-mode.

#+BEGIN_SRC emacs-lisp :eval yes :tangle yes


  (use-package conda
                 :ensure t
                 :custom
                 (conda-anaconda-home (expand-file-name "~/miniforge3"))
  	       (conda-env-home-directory (expand-file-name "~/miniforge3/")))

    (require 'pet)
#+END_src

** Expand region
#+begin_src emacs-lisp :eval yes :tangle yes
      (global-hl-line-mode t)
      (use-package expand-region
        :config
        (bind-key "C-=" 'er/expand-region))
#+END_SRC





** Stan

#+begin_src emacs-lisp :tangle yes
  (use-package stan-mode)
#+end_src

** Require js2-mode

#+begin_src emacs-lisp
  ;(require 'js2-mode)
#+end_src


* Company mode

#+BEGIN_SRC emacs-lisp :tangle yes
  (use-package company
    :config
    (setq company-idle-delay 0 )
    (add-hook 'after-init-hook 'global-company-mode))
#+END_SRC

* Git
CLOSED: [2022-05-25 Wed 13:00]
:LOGBOOK:
- State "DONE"       from "TODO"       [2022-05-25 Wed 13:00] \\
  What a nuisance. Needed to move this to the end /and/ explicitly add the executable
:END:

The moment I evaluate this, I can’t enter an R buffer without “error in process sentinel: Wrong type argument: listp, with-editor”

#+begin_src emacs-lisp  :tangle yes

  ;(custom-set-variables '(with-editor-emacsclient-executable "gnu/store/p4nv1zvdq2ply1qakqhyac3mr7xny9zl-emacs-28.1/bin/emacsclient"))
  (use-package with-editor)
  (use-package magit
    :config
    (bind-key "C-c m" 'magit-status)
    (bind-key "C-c g" 'magiett-file-dispatch))


  (use-package gist)

  ;; (use-package magit-gitflow :config (add-hook 'magit-mode-hook
  ;;   'turn-on-magit-gitflow))

   (use-package git-gutter :config (global-git-gutter-mode +1))
#+end_src




* multiple cursors

#+BEGIN_SRC emacs-lisp :tangle yes

  (use-package multiple-cursors
    :config
    (bind-keys
     ("C-M-c"    . mc/edit-lines)
     ("C->"      . mc/mark-next-like-this)
     ("C-<"      . mc/mark-previous-like-this)
     ("C-c C-<"  .  mc/mark-all-like-this)))

#+END_SRC





* Org roam

#+begin_src emacs-lisp :tangle no


  (use-package org-roam
    :ensure t
    :custom
    (org-roam-directory (expand-file-name  "roam/" org-directory))
    :bind
    (("C-c n l" . org-roam-buffer-toggle)
     ("C-c n f" . org-roam-node-find)
     ("C-c n i" . org-roam-node-insert)
     ("C-c n c" . completion-at-point)
     )
    :config
    (setq org-roam-database-connector 'sqlite-builtin)
    (org-roam-db-autosync-mode)
    ;(org-roam-complete-everywhere t)
    )






#+end_src

* Themes

This is my modus stuff How well does this work? Let’s see what we can get if we make this somewhat wider

#+begin_src emacs-lisp :tangle yes

    (use-package modus-themes
      :config
      (setq modus-themes-mode-line '(accented borderless padded)
	    modus-themes-paren-match '(bold rainbow)
	    modus-themes-mixed-fonts t
	    modus-themes-deuteranopia t
	    modus-themes-slanted-constructs t
	    modus-themes-intense-mouseovers t
	    modus-themes-bold-constructs t
	    modus-themes-org-blocks 'grayscale-background
	    modus-themes-headings '((1 . (rainbow background overline bold 1.3))
				    (2 . (rainbow background 1.2))
				    (3 . (rainbow bold 1.1))
				    (t . (semilight 1.0)))
	    )
      )

  ;(set-face-attribute 'modus-themes-fixed-pitch nil :inherit 'fixed-pitch :height 0.9)
;  (set-face-attribute 'modus-themes-variable-pitch nil :inherit 'variable-pitch :height 1.0)

#+end_src


* Draft

#+begin_src emacs-lisp :tangle yes
  (use-package org-modern
    :ensure t
    :init
    (org-indent-mode -1)
    (modify-all-frames-parameters
     '((right-divider-width . 20)
       (internal-border-width . 20)))
    (dolist (face '(window-divider
                    window-divider-first-pixel
                    window-divider-last-pixel))
      (face-spec-reset-face face)
      (set-face-foreground face (face-attribute 'default :background)))
    (set-face-background 'fringe (face-attribute 'default :background))
    :custom
    (org-auto-align-tags nil)
    (org-tags-column 0)
    (org-catch-invisible-edits 'show-and-error)
    (org-special-ctrl-a/e t)
    (org-insert-heading-respect-content t)
    (org-hide-emphasis-markers t)
    (org-agenda-block-separator ?─)
    (org-pretty-entities t)
    :config
    (global-org-modern-mode))

#+end_src

How does /this/ look?

* Draft


#+begin_src emacs-lisp :tangle yes

  (use-package julia-repl)

  (use-package julia-mode
    :ensure t
    :config
    (add-hook 'julia-mode-hook 'julia-repl-mode)
    (setenv "JULIA_NUM_THREADS" "8"))

#+end_src

#+BEGIN_SRC emacs-lisp :tangle yes
    (use-package yaml-mode
      :init
      (add-hook 'yaml-mode-hook #'turn-off-auto-fill))

  (use-package flycheck-vale
    :ensure t
    :config
    (flycheck-vale-setup))

#+END_SRC



#+begin_src emacs-lisp :tangle yes

  (use-package hide-mode-line)
  (use-package org-appear)
  (defun gtk/org-present-prepare-slide ()
    (org-overview)
    (org-show-entry)
    (org-show-children))

  (defun gtk/org-present-hook ()
    (gtk/org-present-prepare-slide)
    )

  (defun gtk/org-present-start ()
    (setq-local face-remapping-alist '((default (:height 1.5) variable-pitch)
                                       (header-line (:height 4.5) variable-pitch)
                                       (org-document-title (:height 1.75) org-document-title)
                                       (org-code (:height 1.55) org-code)
                                       (org-verbatim (:height 1.55) org-verbatim)
                                       (org-block (:height 1.25) org-block)
                                       (org-block-begin-line (:height 0.7) org-block)))
    (setq header-line-format " ")
    (org-display-inline-images)
    (org-appear-mode -1)
    (git-gutter-mode -1)
    (visual-line-mode 1))

  (defun gtk/org-present-end ()
    (visual-fill-column-mode -1)
    (visual-line-mode -1)
    (setq header-line-format nil)
    (org-remove-inline-images)
    (org-appear-mode 1)
    (setq-local face-remapping-alist '((default variable-pitch default)))
    )


  (defun gtk/org-present-quit-hook ()
    (setq-local face-remapping-alist '((default variable-pitch default)))
    (setq header-line-format nil)
    (org-present-small)
    (org-remove-inline-images)
    (org-appear-mode 1))


  (defun gtk/org-present-prev ()
    (interactive)
    (org-present-prev)
    (gtk/org-present-prepare-slide))

  (defun gtk/org-present-next ()
    (interactive)
    (org-present-next)
    (gtk/org-present-prepare-slide)
    (when (fboundp 'live-crafter-add-timestamp)
      (live-crafter-add-timestamp (substring-no-properties (org-get-heading t t t t)))))

  (use-package org-present
    :bind (:map org-present-mode-keymap
		("C-c C-j" . gtk/org-present-next)
		("C-c C-k" . gtk/org-present-prev))
    :config
    (add-hook 'org-present-mode-hook #'gtk/org-present-start)
    (add-hook 'org-present-mode-quit-hook #'gtk/org-present-end))





#+end_src

#+BEGIN_SRC emacs-lisp :tangle no
  (use-package org-ref
      :after org)
  (define-key org-mode-map (kbd "C-c ]") 'org-ref-insert-link)
#+END_SRC




#+BEGIN_SRC emacs-lisp :tangle yes

  (setq org-file-apps
        '((auto-mode . emacs)
          (directory . "setsid xdg-open \"%s\"")
          ("\\.x?html?\\'" . "chrome \"%s\"")
          ("\\.pdf\\'" . "evince \"%s\"")
          ("\\.pdf::\\([0-9]+\\)\\'" . "evince \"%s\" -p %1")
          ("\\.doc?x?\\'" . "libreoffice \"%s\"")))


#+END_SRC


#+begin_src emacs-lisp :tangle yes
  ;; (use-package lsp-mode
  ;;   :init
  ;;   (setq lsp-keymap-prefix "C-c C-l")
  ;;   :hook (python-mode . lsp)
  ;;   :commands lsp)

  ;; optionally
  ;(use-package lsp-ui :commands lsp-ui-mode)
  ;(use-package company-lsp :commands company-lsp)
  ;;(use-package helm-lsp :commands helm-lsp-workspace-symbol)
  ;(use-package lsp-treemacs :commands lsp-treemacs-errors-list)

  ;; optionally if you want to use debugger
  ;;(use-package dap-mode)

#+end_src



#+begin_src emacs-lisp :tangle yes
  ;; unfilling

  (defun unfill-paragraph (&optional region)
        "Takes a multi-line paragraph and makes it into a single line of text."
        (interactive (progn (barf-if-buffer-read-only) '(t)))
        (let ((fill-column (point-max))
              ;; This would override `fill-column' if it's an integer.
              (emacs-lisp-docstring-fill-column t))
          (fill-paragraph nil region)))
#+end_src



#+begin_src emacs-lisp :tangle yes
  (use-package org-contrib)
  (require 'org-checklist)
  (add-to-list 'org-export-filter-final-output-functions 'gtk/unnumbered-beamer-caption)
  (add-to-list 'org-export-filter-final-output-functions 'gtk/unnumbered-latex-captions)  
  (add-to-list 'org-export-filter-parse-tree-functions 'org-export-ignore-headlines)
#+end_src


* Go!

#+begin_src emacs-lisp :tangle yes
  (fresh-load-theme 'modus-operandi)

#+end_src


* Quarto

#+begin_src emacs-lisp :tangle yes :eval yes
  (use-package request)
  (use-package polymode)
  (use-package poly-markdown)
  (use-package markdown-mode)

    (use-package quarto-mode
    :mode
    (("\\.Rmd" . poly-quarto-mode)))

#+end_src

* Draft

#+begin_src emacs-lisp :tangle yes
  (use-package dockerfile-mode)
  (use-package org-modern
    :ensure t
    :init
    (org-indent-mode -1)
    (modify-all-frames-parameters
     '((right-divider-width . 20)
       (internal-border-width . 20)))
    (dolist (face '(window-divider
                    window-divider-first-pixel
                    window-divider-last-pixel))
      (face-spec-reset-face face)
      (set-face-foreground face (face-attribute 'default :background)))
    (set-face-background 'fringe (face-attribute 'default :background))
    :custom
    (org-auto-align-tags nil)
    (org-tags-column 0)
    (org-catch-invisible-edits 'show-and-error)
    (org-special-ctrl-a/e t)
    (org-insert-heading-respect-content t)
    (org-hide-emphasis-markers t)
    (org-agenda-block-separator ?─)
    (org-pretty-entities t)
    :config
    (global-org-modern-mode)
    (fresh-load-theme 'modus-operandi
    ))
#+end_src


* Conda

#+begin_src emacs-lisp :tangle yes

  (setenv "WORKON_HOME" "~/miniforge3/envs")
#+end_src

#+begin_src emacs-lisp
  (use-package sparql-mode
    :mode
    (("\\.sparql" . sparql-mode)))
#+end_src



* Some extra


#+begin_src emacs-lisp
(use-package groovy-mode)
  
#+end_src

#+begin_src emacs-lisp :tangle yes
    (setq org-beamer-environments-extra
          '(("ponly" "P" "\\begin{ponly}%a{%h}" "\\end{ponly}")
  	  ("fill" "D" "{\\molochset{block=fill}\\noop \\\\ \\begin{block}%a{%h}" "\\end{block}}"))
    	)

    (use-package snakemake-mode)

    (use-package rustic
    :ensure
    :bind (:map rustic-mode-map
                ("M-j" . lsp-ui-imenu)
                ("M-?" . lsp-find-references)
                ("C-c C-c l" . flycheck-list-errors)
                ("C-c C-c a" . lsp-execute-code-action)
                ("C-c C-c r" . lsp-rename)
                ("C-c C-c q" . lsp-workspace-restart)
                ("C-c C-c Q" . lsp-workspace-shutdown)
                ("C-c C-c s" . lsp-rust-analyzer-status))
    :config
    ;; uncomment for less flashiness
    ;; (setq lsp-eldoc-hook nil)
    ;; (setq lsp-enable-symbol-highlighting nil)
    ;; (setq lsp-signature-auto-activate nil)

    ;; comment to disable rustfmt on save
    (setq rustic-format-on-save t)
    (add-hook 'rustic-mode-hook 'rk/rustic-mode-hook))

  (defun rk/rustic-mode-hook ()
    ;; so that run C-c C-c C-r works without having to confirm, but don't try to
    ;; save rust buffers that are not file visiting. Once
    ;; https://github.com/brotzeit/rustic/issues/253 has been resolved this should
    ;; no longer be necessary.
    (when buffer-file-name
      (setq-local buffer-save-without-query t))
    (add-hook 'before-save-hook 'lsp-format-buffer nil t))

  #+end_src
